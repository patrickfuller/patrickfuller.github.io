<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Images are data - Image processing for scientists and engineers, Part 1</title>
        <meta name="viewport" content="width=device-width">

        <!-- CSS - font, bootstrap, syntax, custom -->
        <link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="/css/bootstrap.css">
        <link rel="stylesheet" href="/css/font-awesome.min.css">
        <link rel="stylesheet" href="/css/syntax.css">
        <link rel="stylesheet" href="/css/main.css">

    </head>
    <body>

        <div class="site">
          <div class="header">
            <h1 class="title"><a href="/">patrick fuller's blog</a></h1>
            <a class="extra" href="/">home</a>
          </div>

          <h2>Images are data - Image processing for scientists and engineers, Part 1</h2>
<p class="meta">22 Oct 2012</p>

<div class="post">
<p>The need to extract information from images and videos is a perennial issue in
experimental work. As such, scientific image processing is a topic I&#39;ve been wanting
to address for some time now. This represents the first of a six-part tutorial
focusing on what I consider to be the core of image processing. With the tools
shown in these lessons, you will be able to automate the analysis and interpretation
of experimental work, simultaneously decreasing human error and reducing the amount
of time you have to spend in the lab.</p>

<p>In this post, I will go in to the fundamentals of image processing. This covers
viewing images as data and creating basic logic to extract information from experimental
images. Future posts will focus on the latter topic, extending into the field of
computer vision and image processing algorithms.</p>

<p>All code examples are written in <a href="http://processing.org/">Processing</a>, a really
fun Java superlanguage focused on, well, processing images. If you&#39;re at all
interested in computer vision, I&#39;d highly recommend looking into it. For those of
you who don&#39;t mind approaching image processing as a magical black box, Matlab
has a <a href="http://www.mathworks.com/products/image/">solid toolkit</a>, and, if you&#39;re
a little more code savvy, <a href="http://opencv.willowgarage.com/wiki/">OpenCV</a> is
downright awesome. That being said, black box + science is always a terrible idea,
and I claim no responsibility for misinterpreted data. Read the damn tutorial.</p>

<p>The 3D visualizations were done in Blender. The script I used to do so is stored
in a Github repo <a href="https://github.com/patrickfuller/blender-image-pixels">here</a>.</p>

<h2>Images are data</h2>

<p>As a starting point, consider black-and-white images. These are very common in
small-scale science, as color isn&#39;t really a thing when you&#39;re talking sizes
smaller than visible light wavelengths (think SEM output and the like). So, as
an example, here&#39;s a grayscale image I took of my living room.</p>

<p><img src="/img/living_room.png" alt=""></p>

<p>Digital images, not surprisingly, are composed of pixels. In the case of black-and-white
images, each pixel can take an integer value from 0 to 255. 0 is black, 255 is
white. The sample image is 800 x 600 pixels, so it consists of (800*600) 480,000
data points. Which brings me to my next point:</p>

<h2>Images are a <em>lot</em> of data</h2>

<p>In the small sample image above, we&#39;re dealing with half a million numbers.
Full-res SEM images can be 5,000 x 5,000 pixels, representing 25 million data
points. In many bio experiments, you have full-fledged videos of cells and whatnot.
A 1080p RGB 30 fps video camera is producing (1920*1080*3*30) 186.6 million data
points <em>per second</em>. That&#39;s enough space to store the entirety of <em>Moby Dick</em> 200
times over!</p>

<p>Why am I emphasizing this so much? Simple: keeping this in mind will save you
headaches (ie. crashed laptops) when we get to data manipulation. If you&#39;re
processing a lot of images, don&#39;t be afraid of scaling down the size (in fact,
this is a good approach to reduce noise!).</p>

<h2>Data can be manipulated</h2>

<p>To convert the image above into a more mathematical notation, we are dealing with
an 800 x 600 matrix of numbers. So, what can we do with this representation? The
short answer: a lot. Let&#39;s start with some simple ideas and get coding.</p>

<p>First, here&#39;s a plot of a downsized version of the input image. Take this as our
starting point - we&#39;ll move forward from here.</p>

<p><img src="/img/living_room_3d.png" alt=""></p>

<p>Without any manipulation, you can already see some patterns. The furniture is dark,
which means that the data in that area will have low values (remember that pure
black is 0). Contrasting this is the light source in the top left, which is producing
a region of pure white. The remaining data - the walls and floor - are slightly
noisy gray areas. Let&#39;s use this information to write our first image processing
functions.</p>

<p>In Processing, we can iterate through the pixels of an image easily enough.</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * Iterates through all of the pixels in an image</span>
<span class="cm"> */</span>
<span class="n">PImage</span> <span class="nf">iterate</span><span class="o">(</span><span class="n">PImage</span> <span class="n">img</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">img</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">;</span> <span class="n">y</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>
      <span class="n">img</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">]</span> <span class="o">=</span> <span class="c1">// Do something here!</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="k">return</span> <span class="n">img</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>The only confusing aspect of this code is the <code>loc = x + y * img.width</code> line.
This is simply a conversion between our 2D representation of images and how the
pixels are actually stored in the computer. Not a big deal.</p>

<p>Using this, we can play around with some ideas. We know that the furniture is
black and the lights are white. Let&#39;s use that to create functions <code>findFurniture</code>
and <code>findLights</code>. First, <code>findFurniture</code>:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * Highlights all dark pixels in an input image</span>
<span class="cm"> */</span>
<span class="n">PImage</span> <span class="nf">findFurniture</span><span class="o">(</span><span class="n">PImage</span> <span class="n">img</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">PImage</span> <span class="n">output</span> <span class="o">=</span> <span class="n">createImage</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="sc">&#39;L&#39;</span><span class="o">);</span>
  <span class="n">img</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="n">output</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">;</span> <span class="n">y</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>

      <span class="c1">// If the input pixel is dark, highlight the output pixel</span>
      <span class="kt">int</span> <span class="n">col</span><span class="o">;</span>
      <span class="k">if</span><span class="o">(</span><span class="n">brightness</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">])</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="mi">60</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">255</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// Otherwise, the output pixel is black</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">output</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">]</span> <span class="o">=</span> <span class="n">color</span><span class="o">(</span><span class="n">col</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">output</span><span class="o">.</span><span class="na">updatePixels</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>This function iterates through the pixels of the living room image. If a pixel is
dark (ie. if it&#39;s furniture), then place a white pixel in the output image.
Otherwise, place a black pixel. The output looks like this:</p>

<p><img src="/img/find_furniture.png" alt=""></p>

<p>All in all, it did a decent job of finding the furniture in the image. We can use
the same logic to find the lights, now looking for light areas instead of dark ones.</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * Highlights all bright pixels in an input image</span>
<span class="cm"> */</span>
<span class="n">PImage</span> <span class="nf">findLights</span><span class="o">(</span><span class="n">PImage</span> <span class="n">img</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">PImage</span> <span class="n">output</span> <span class="o">=</span> <span class="n">createImage</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="sc">&#39;L&#39;</span><span class="o">);</span>
  <span class="n">img</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="n">output</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">;</span> <span class="n">y</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>

      <span class="c1">// If the input pixel is light, highlight the output pixel</span>
      <span class="kt">int</span> <span class="n">col</span><span class="o">;</span>
      <span class="k">if</span><span class="o">(</span><span class="n">brightness</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">])</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">230</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">255</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// Otherwise, the output pixel is black</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">output</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">]</span> <span class="o">=</span> <span class="n">color</span><span class="o">(</span><span class="n">col</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">output</span><span class="o">.</span><span class="na">updatePixels</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>Here, the light in the top left and its window reflection are highlighted.</p>

<p><img src="/img/find_light.png" alt=""></p>

<p>This approach is aptly called <em>threshold filtering</em>, and it&#39;s super easy. Believe
it or not, it&#39;s enough to solve a lot of image processing dilemmas in science.
For example, let&#39;s say we want to track the purple nucleus of a dyed cell. The
function:</p>
<div class="highlight"><pre><code class="java language-java" data-lang="java"><span class="cm">/**</span>
<span class="cm"> * Finds the nucleus of a cell using the fact it&#39;s purple</span>
<span class="cm"> */</span>
<span class="n">PImage</span> <span class="nf">findNuclei</span><span class="o">(</span><span class="n">PImage</span> <span class="n">img</span><span class="o">)</span> <span class="o">{</span>
  <span class="n">PImage</span> <span class="n">output</span> <span class="o">=</span> <span class="n">createImage</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">,</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">,</span> <span class="sc">&#39;L&#39;</span><span class="o">);</span>
  <span class="n">img</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="n">output</span><span class="o">.</span><span class="na">loadPixels</span><span class="o">();</span>
  <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">x</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span> <span class="n">x</span><span class="o">++)</span> <span class="o">{</span>
    <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">y</span> <span class="o">&amp;</span><span class="n">lt</span><span class="o">;</span> <span class="n">img</span><span class="o">.</span><span class="na">height</span><span class="o">;</span> <span class="n">y</span><span class="o">++)</span> <span class="o">{</span>
      <span class="kt">int</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">*</span> <span class="n">img</span><span class="o">.</span><span class="na">width</span><span class="o">;</span>

      <span class="c1">// If the input pixel has red and blue elements, highlight it</span>
      <span class="kt">int</span> <span class="n">col</span><span class="o">;</span>
      <span class="k">if</span><span class="o">(</span><span class="n">blue</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">])</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">100</span> <span class="o">&amp;&amp;</span> <span class="n">red</span><span class="o">(</span><span class="n">img</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">])</span> <span class="o">&amp;</span><span class="n">gt</span><span class="o">;</span> <span class="mi">50</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">255</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="c1">// Otherwise, the output pixel is black</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
      <span class="o">}</span>
      <span class="n">output</span><span class="o">.</span><span class="na">pixels</span><span class="o">[</span><span class="n">loc</span><span class="o">]</span> <span class="o">=</span> <span class="n">color</span><span class="o">(</span><span class="n">col</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
  <span class="n">output</span><span class="o">.</span><span class="na">updatePixels</span><span class="o">();</span>
  <span class="k">return</span> <span class="n">output</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>
<p>yields the output</p>

<p><img src="/img/cell_ratchet.png" alt=""></p>

<p>One thing to note is that we&#39;re now working with color images. This is very
similar to working with black-and-white images, but now we have even more data!
A color image generally breaks down into <em>red</em>, <em>green</em>, and <em>blue</em> channels,
which Processing allows you to access with <code>red()</code>, <code>green()</code>, and <code>blue()</code>
functions. Convenient, right? You can use differences in color as thresholds;
it&#39;s the same thing we did before with brightness, but much more expressive.</p>

<p>Take some time to play around with these ideas. A lot of scientific image processing
can be done with the techniques shown here mixed with a healthy dose of intuition.</p>

<p>In the <a href="/convolution-an-introduction-to-image-processing-for-scientists-and-engineers/">next post</a>,
I&#39;ll tackle image convolution. From there, we&#39;ll discuss some of the most
popular filters.</p>

</div>

<!-- Disqus comments -->
<script type="text/javascript">
  var disqus_shortname = 'patrickfuller';
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>

<!-- MathJax LaTeX editor, with edits from http://stackoverflow.com/questions/10987992/using-mathjax-with-jekyll -->
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript">
  MathJax.Hub.Config({
    tex2jax: {
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
    }
  });
  MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for(i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
      }
  });
</script>


          <div id="disqus_thread"></div>

          <div class="footer">
            <div class="contact">
              <p>
                <a href="mailto:patrickfuller@gmail.com"><i class="fa fa-envelope"></i></a>
                <a href="https://github.com/patrickfuller"><i class="fa fa-github"></i></a>
              </p>
            </div>
          </div>
        </div>

    <!-- Javascript -->
    <script src="/js/jquery-1.10.2.min.js"></script>
    <script src="/js/bootstrap.min.js"></script>
  </body>
</html>
